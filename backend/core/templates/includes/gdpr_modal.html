<!-- backend/core/templates/includes/gdpr_modal.html -->
<!-- GDPR Cookie Consent - Компактный баннер -->

<!-- Баннер снизу -->
<div id="gdpr-banner">
    <div class="gdpr-banner-inner">
        <p class="gdpr-banner-text">
            Wir verwenden Cookies, um Ihnen die beste Nutzererfahrung zu bieten.
            <a href="/datenschutz/">Datenschutzerklärung</a>
        </p>
        <div class="gdpr-banner-buttons">
            <button type="button" class="gdpr-btn-settings" onclick="openGdprSettings()">Einstellungen</button>
            <button type="button" class="gdpr-btn-accept" onclick="acceptAllGdpr()">Alle akzeptieren</button>
        </div>
    </div>
</div>

<!-- Модальное окно настроек -->
<div id="gdpr-modal" class="gdpr-modal-overlay">
    <div class="gdpr-modal">
        <div class="gdpr-modal-header">
            <h3>Cookie-Einstellungen</h3>
            <button type="button" class="gdpr-close" onclick="closeGdprModal()">&times;</button>
        </div>
        <div class="gdpr-modal-body">
            <p class="gdpr-intro">Wählen Sie, welche Cookies Sie zulassen möchten. Notwendige Cookies sind für den Betrieb der Website erforderlich.</p>
            
            <div class="gdpr-option">
                <label class="gdpr-toggle">
                    <input type="checkbox" id="gdpr-necessary" checked disabled>
                    <span class="gdpr-slider"></span>
                </label>
                <div class="gdpr-option-info">
                    <strong>Notwendig</strong>
                    <span class="gdpr-badge">Immer aktiv</span>
                    <p>Essenzielle Cookies für Grundfunktionen wie Login und Sicherheit.</p>
                </div>
            </div>
            
            <div class="gdpr-option">
                <label class="gdpr-toggle">
                    <input type="checkbox" id="gdpr-functional">
                    <span class="gdpr-slider"></span>
                </label>
                <div class="gdpr-option-info">
                    <strong>Funktional</strong>
                    <p>Speichern Ihre Präferenzen wie Sprache und Region.</p>
                </div>
            </div>
            
            <div class="gdpr-option">
                <label class="gdpr-toggle">
                    <input type="checkbox" id="gdpr-analytics">
                    <span class="gdpr-slider"></span>
                </label>
                <div class="gdpr-option-info">
                    <strong>Analyse</strong>
                    <p>Helfen uns, die Website-Nutzung zu verstehen (Google Analytics, Yandex Metrika).</p>
                </div>
            </div>
        </div>
        <div class="gdpr-modal-footer">
            <button type="button" class="gdpr-btn-reject" onclick="rejectAllGdpr()">Nur notwendige</button>
            <button type="button" class="gdpr-btn-accept-all" onclick="acceptAllGdpr()">Alle akzeptieren</button>
        </div>
    </div>
</div>

<style>
/* Баннер */
#gdpr-banner {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #fff;
    box-shadow: 0 -4px 30px rgba(0,0,0,0.12);
    padding: 16px 20px;
    z-index: 99998;
    display: none;
    border-top: 3px solid #336AEA;
}
.gdpr-banner-inner {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    flex-wrap: wrap;
}
.gdpr-banner-text {
    margin: 0;
    font-size: 14px;
    color: #333;
    flex: 1;
    min-width: 200px;
}
.gdpr-banner-text a { color: #336AEA; text-decoration: underline; }
.gdpr-banner-buttons { display: flex; gap: 10px; flex-shrink: 0; }
.gdpr-btn-settings {
    padding: 10px 18px;
    border: 1px solid #ddd;
    background: #fff;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
}
.gdpr-btn-settings:hover { border-color: #336AEA; color: #336AEA; }
.gdpr-btn-accept {
    padding: 10px 22px;
    background: linear-gradient(135deg, #336AEA 0%, #5B8DEF 100%);
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
}
.gdpr-btn-accept:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(51,106,234,0.3); }

/* Модальное окно */
.gdpr-modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 99999;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
}
.gdpr-modal-overlay.active { display: flex; }
.gdpr-modal {
    background: #fff;
    border-radius: 16px;
    max-width: 480px;
    width: 100%;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    animation: gdprSlideUp 0.3s ease;
}
@keyframes gdprSlideUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
.gdpr-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid #eee;
}
.gdpr-modal-header h3 { margin: 0; font-size: 18px; color: #1a1a1a; }
.gdpr-close { background: none; border: none; font-size: 28px; color: #999; cursor: pointer; }
.gdpr-close:hover { color: #333; }
.gdpr-modal-body { padding: 20px 24px; }
.gdpr-intro { font-size: 14px; color: #666; margin: 0 0 20px; line-height: 1.5; }
.gdpr-option { display: flex; gap: 14px; padding: 14px 0; border-bottom: 1px solid #f0f0f0; }
.gdpr-option:last-child { border-bottom: none; }
.gdpr-option-info { flex: 1; }
.gdpr-option-info strong { display: block; font-size: 14px; color: #1a1a1a; margin-bottom: 2px; }
.gdpr-option-info p { margin: 4px 0 0; font-size: 13px; color: #666; line-height: 1.4; }
.gdpr-badge { display: inline-block; font-size: 10px; padding: 2px 6px; background: #e8e8e8; border-radius: 4px; color: #666; }

/* Toggle */
.gdpr-toggle { position: relative; width: 44px; height: 24px; flex-shrink: 0; }
.gdpr-toggle input { opacity: 0; width: 0; height: 0; }
.gdpr-slider {
    position: absolute; cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background: #ccc; border-radius: 24px; transition: 0.3s;
}
.gdpr-slider:before {
    content: ""; position: absolute;
    height: 18px; width: 18px; left: 3px; bottom: 3px;
    background: #fff; border-radius: 50%; transition: 0.3s;
}
.gdpr-toggle input:checked + .gdpr-slider { background: #336AEA; }
.gdpr-toggle input:checked + .gdpr-slider:before { transform: translateX(20px); }
.gdpr-toggle input:disabled + .gdpr-slider { background: #a8c7fa; cursor: not-allowed; }

/* Footer */
.gdpr-modal-footer { display: flex; gap: 10px; padding: 16px 24px; background: #f9f9f9; border-top: 1px solid #eee; }
.gdpr-btn-reject {
    flex: 1; padding: 12px;
    border: 1px solid #ddd; background: #fff;
    border-radius: 8px; cursor: pointer; font-size: 14px;
}
.gdpr-btn-reject:hover { border-color: #999; }
.gdpr-btn-accept-all {
    flex: 1; padding: 12px;
    background: linear-gradient(135deg, #336AEA 0%, #5B8DEF 100%);
    color: #fff; border: none; border-radius: 8px;
    cursor: pointer; font-size: 14px; font-weight: 500;
}

@media (max-width: 600px) {
    .gdpr-banner-inner { flex-direction: column; text-align: center; }
    .gdpr-banner-buttons { width: 100%; justify-content: center; }
    .gdpr-modal-footer { flex-direction: column; }
}
</style>

<script>
(function() {
    const STORAGE_KEY = 'blisterperpost_gdpr_consent';
    const CONSENT_VERSION = '1.1';
    
    function getConsent() {
        try {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                const parsed = JSON.parse(data);
                if (parsed.version === CONSENT_VERSION) return parsed;
            }
        } catch (e) {}
        return null;
    }
    
    function saveConsent(consent) {
        const data = {
            version: CONSENT_VERSION,
            timestamp: new Date().toISOString(),
            necessary: true,
            functional: consent.functional || false,
            analytics: consent.analytics || false
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        document.cookie = `gdpr_consent=${btoa(JSON.stringify(data))}; path=/; max-age=31536000; SameSite=Lax`;
        return data;
    }
    
    function showBanner() {
        const b = document.getElementById('gdpr-banner');
        if (b) b.style.display = 'block';
    }
    
    function hideBanner() {
        const b = document.getElementById('gdpr-banner');
        if (b) b.style.display = 'none';
    }
    
    window.openGdprSettings = function() {
        const modal = document.getElementById('gdpr-modal');
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        const consent = getConsent();
        if (consent) {
            document.getElementById('gdpr-functional').checked = consent.functional;
            document.getElementById('gdpr-analytics').checked = consent.analytics;
        }
    };
    
    window.closeGdprModal = function() {
        const modal = document.getElementById('gdpr-modal');
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
    };
    
    window.acceptAllGdpr = function() {
        saveConsent({ functional: true, analytics: true });
        hideBanner();
        closeGdprModal();
        applyConsent({ functional: true, analytics: true });
    };
    
    window.rejectAllGdpr = function() {
        saveConsent({ functional: false, analytics: false });
        hideBanner();
        closeGdprModal();
    };
    
    window.saveGdprSettings = function() {
        const consent = {
            functional: document.getElementById('gdpr-functional').checked,
            analytics: document.getElementById('gdpr-analytics').checked
        };
        saveConsent(consent);
        hideBanner();
        closeGdprModal();
        applyConsent(consent);
    };
    
    function applyConsent(consent) {
        if (consent.analytics) {
            // Здесь загрузка GA4 / Yandex Metrika
        }
    }
    
    document.addEventListener('click', function(e) {
        if (e.target === document.getElementById('gdpr-modal')) closeGdprModal();
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeGdprModal();
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        const consent = getConsent();
        if (!consent) showBanner();
        else applyConsent(consent);
    });
})();
</script>