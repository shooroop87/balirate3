{% extends "account/onboarding/base_onboarding.html" %}
{% load static i18n %}

{% block title %}{% trans "Zahlungsmethode" %}{% endblock %}

{% block onboarding_content %}
<div class="onboarding-header">
    <div class="icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
            <line x1="1" y1="10" x2="23" y2="10"/>
        </svg>
    </div>
    <h1>{% trans "Zahlungsmethode einrichten" %}</h1>
    <p>{% trans "Sichere Zahlung √ºber PayPal ‚Äì keine Abbuchung ohne Ihre Zustimmung" %}</p>
</div>

<!-- Plan Summary -->
<div class="plan-summary">
    <div class="plan-summary-header">
        <span class="label">{% trans "Gew√§hlter Tarif" %}</span>
        <a href="{% url 'onboarding_plan' %}" class="change-link">{% trans "√Ñndern" %}</a>
    </div>
    <div class="plan-name">{{ plan.name }}</div>
    <div class="plan-details">
        <span>{{ plan.get_interval_days_display }}</span>
        <span class="plan-price">{{ plan.price }} ‚Ç¨/{{ plan.get_interval_days_display }}</span>
    </div>
</div>

<!-- PayPal Info -->
<div class="paypal-info">
    <div class="paypal-logo">
        <svg xmlns="http://www.w3.org/2000/svg" width="100" height="26" viewBox="0 0 100 26">
            <path fill="#253B80" d="M12.2 4.3H6.8c-.4 0-.7.3-.8.6L4 18.2c0 .3.2.5.5.5h2.6c.4 0 .7-.3.8-.6l.5-3.4c0-.4.4-.6.8-.6h1.8c3.6 0 5.7-1.7 6.2-5.2.2-1.5 0-2.7-.7-3.5-.7-1-2-1.1-3.3-1.1zm.6 5.1c-.3 2-1.8 2-3.2 2h-.8l.6-3.6c0-.2.2-.3.4-.3h.4c1 0 1.9 0 2.4.6.3.3.4.8.2 1.3z"/>
            <path fill="#179BD7" d="M35.5 9.3h-2.6c-.2 0-.4.1-.4.3l-.1.7-.2-.2c-.5-.8-1.7-1-2.9-1-2.7 0-5 2-5.5 4.9-.2 1.4.1 2.8.9 3.7.7.9 1.8 1.2 3 1.2 2.1 0 3.3-1.4 3.3-1.4l-.1.7c0 .3.2.5.5.5h2.4c.4 0 .7-.3.8-.6l1.4-9.2c0-.4-.2-.6-.5-.6zm-3.3 4.7c-.2 1.4-1.4 2.3-2.8 2.3-.7 0-1.3-.2-1.6-.6-.4-.4-.5-1-.4-1.7.2-1.4 1.4-2.3 2.8-2.3.7 0 1.3.2 1.6.6.4.4.5 1 .4 1.7z"/>
            <path fill="#253B80" d="M55.2 9.3h-2.6c-.2 0-.5.1-.6.3l-3.6 5.3-1.5-5.1c-.1-.3-.4-.5-.7-.5h-2.6c-.3 0-.6.3-.5.7l2.9 8.4-2.7 3.8c-.2.3 0 .8.4.8h2.6c.2 0 .5-.1.6-.3l8.7-12.6c.2-.3 0-.8-.4-.8z"/>
            <path fill="#179BD7" d="M67.2 4.3h-5.4c-.4 0-.7.3-.8.6L59 18.2c0 .3.2.5.5.5h2.8c.3 0 .5-.2.5-.4l.6-3.6c0-.4.4-.6.8-.6h1.8c3.6 0 5.7-1.7 6.2-5.2.2-1.5 0-2.7-.7-3.5-.8-1-2.1-1.1-3.3-1.1zm.6 5.1c-.3 2-1.8 2-3.2 2h-.8l.6-3.6c0-.2.2-.3.4-.3h.4c1 0 1.9 0 2.4.6.3.3.3.8.2 1.3z"/>
            <path fill="#179BD7" d="M90.5 9.3h-2.6c-.2 0-.4.1-.4.3l-.1.7-.2-.2c-.5-.8-1.7-1-2.9-1-2.7 0-5 2-5.5 4.9-.2 1.4.1 2.8.9 3.7.7.9 1.8 1.2 3 1.2 2.1 0 3.3-1.4 3.3-1.4l-.1.7c0 .3.2.5.5.5h2.4c.4 0 .7-.3.8-.6l1.4-9.2c0-.4-.2-.6-.5-.6zm-3.3 4.7c-.2 1.4-1.4 2.3-2.8 2.3-.7 0-1.3-.2-1.6-.6-.4-.4-.5-1-.4-1.7.2-1.4 1.4-2.3 2.8-2.3.7 0 1.3.2 1.6.6.4.4.5 1 .4 1.7z"/>
            <path fill="#253B80" d="M95.1 4.7l-2.1 13.4c0 .3.2.5.5.5h2.2c.4 0 .7-.3.8-.6L98.5 5c0-.3-.2-.5-.5-.5h-2.4c-.2-.1-.4.1-.5.2z"/>
        </svg>
    </div>
    <p>{% trans "Sie werden zu PayPal weitergeleitet, um die Zahlung einzurichten." %}</p>
</div>

<!-- Security Notice -->
<div class="security-notice">
    <div class="security-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
    </div>
    <div class="security-text">
        <strong>{% trans "Sichere Zahlung" %}</strong>
        <span>{% trans "Keine Abbuchung ohne Ihre Zustimmung. Erst nach Pr√ºfung Ihrer Dokumente." %}</span>
    </div>
</div>

<!-- What happens next -->
<div class="next-steps">
    <h4>{% trans "Was passiert als N√§chstes?" %}</h4>
    <div class="next-steps-list">
        <div class="next-step">
            <div class="step-icon">üìã</div>
            <div class="step-text">
                <strong>{% trans "Dokumentenpr√ºfung" %}</strong>
                <span>{% trans "Unsere Apotheker pr√ºfen Ihre Rezepte" %}</span>
            </div>
        </div>
        <div class="next-step">
            <div class="step-icon">üìû</div>
            <div class="step-text">
                <strong>{% trans "Kontaktaufnahme" %}</strong>
                <span>{% trans "Wir melden uns per Telefon oder E-Mail" %}</span>
            </div>
        </div>
        <div class="next-step">
            <div class="step-icon">üí≥</div>
            <div class="step-text">
                <strong>{% trans "Erste Zahlung" %}</strong>
                <span>{% trans "Erst wenn alles bereit ist und wir versenden" %}</span>
            </div>
        </div>
    </div>
</div>

<form method="post" id="paymentForm">
    {% csrf_token %}
    <div class="onboarding-actions">
        <a href="{% url 'onboarding_plan' %}" class="btn-onboarding secondary">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            {% trans "Zur√ºck" %}
        </a>
        <button type="submit" class="btn-onboarding primary btn-paypal" id="submitBtn">
            <span id="btnText">{% trans "Weiter zu PayPal" %}</span>
            <span id="btnLoading" style="display:none;">
                <svg class="spinner" width="20" height="20" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="60" stroke-linecap="round"><animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/></circle></svg>
                {% trans "Wird verarbeitet..." %}
            </span>
            <svg id="btnArrow" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
        </button>
    </div>
</form>

<div class="terms-note">
    <p>
        {% trans "Mit dem Klick auf 'Weiter zu PayPal' akzeptieren Sie unsere" %}
        <a href="{% url 'terms' %}" target="_blank">{% trans "AGB" %}</a>
        {% trans "und best√§tigen, dass Sie die" %}
        <a href="{% url 'privacy' %}" target="_blank">{% trans "Datenschutzerkl√§rung" %}</a>
        {% trans "gelesen haben." %}
    </p>
</div>
{% endblock %}

{% block onboarding_css %}
<style>
/* Plan Summary */
.plan-summary {
    background: #f8fafc;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 25px;
}
.plan-summary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}
.plan-summary-header .label {
    font-size: 12px;
    color: #64748b;
    text-transform: uppercase;
    font-weight: 600;
}
.change-link {
    font-size: 13px;
    color: #336AEA;
    text-decoration: none;
}
.plan-name {
    font-size: 18px;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 5px;
}
.plan-details {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
    color: #64748b;
}
.plan-price {
    font-weight: 600;
    color: #336AEA;
}

/* PayPal Info */
.paypal-info {
    background: linear-gradient(135deg, #f0f7ff 0%, #e8f4fd 100%);
    border: 2px solid #0070ba;
    border-radius: 16px;
    padding: 30px;
    text-align: center;
    margin-bottom: 25px;
}
.paypal-logo {
    margin-bottom: 15px;
}
.paypal-info p {
    color: #1e293b;
    margin: 0;
    font-size: 15px;
}

/* Security Notice */
.security-notice {
    display: flex;
    align-items: center;
    gap: 15px;
    background: #ecfdf5;
    border: 1px solid #a7f3d0;
    border-radius: 12px;
    padding: 15px 20px;
    margin-bottom: 25px;
}
.security-icon {
    width: 40px;
    height: 40px;
    background: #10B981;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    flex-shrink: 0;
}
.security-text strong {
    display: block;
    font-size: 14px;
    color: #065f46;
    margin-bottom: 2px;
}
.security-text span {
    font-size: 13px;
    color: #047857;
}

/* Next Steps */
.next-steps {
    background: #f8fafc;
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 30px;
}
.next-steps h4 {
    font-size: 15px;
    margin: 0 0 20px;
    color: #1e293b;
}
.next-steps-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.next-step {
    display: flex;
    align-items: center;
    gap: 15px;
}
.step-icon {
    width: 40px;
    height: 40px;
    background: #fff;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.step-text strong {
    display: block;
    font-size: 14px;
    color: #1e293b;
    margin-bottom: 2px;
}
.step-text span {
    font-size: 13px;
    color: #64748b;
}

/* PayPal Button */
.btn-paypal {
    background: linear-gradient(135deg, #0070ba, #003087) !important;
}
.btn-paypal:hover {
    box-shadow: 0 8px 25px rgba(0, 112, 186, 0.4) !important;
}

/* Terms */
.terms-note {
    text-align: center;
    margin-top: 20px;
}
.terms-note p {
    font-size: 12px;
    color: #94a3b8;
    margin: 0;
}
.terms-note a {
    color: #336AEA;
}

/* Spinner */
.spinner {
    animation: rotate 1s linear infinite;
}
@keyframes rotate {
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block onboarding_js %}
<script>
document.getElementById('paymentForm').addEventListener('submit', function() {
    var btn = document.getElementById('submitBtn');
    var btnText = document.getElementById('btnText');
    var btnLoading = document.getElementById('btnLoading');
    var btnArrow = document.getElementById('btnArrow');
    
    btn.disabled = true;
    btnText.style.display = 'none';
    btnArrow.style.display = 'none';
    btnLoading.style.display = 'inline-flex';
});
</script>
{% endblock %}

{% block analytics_events %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // üìä –¢—Ä–µ–∫–∏–Ω–≥ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ–ø–ª–∞—Ç—ã
    if (typeof BPPAnalytics !== 'undefined') {
        BPPAnalytics.track('onboarding_payment', {
            funnel_step: 7,
            step_name: 'payment',
            plan_name: '{{ plan.name }}',
            plan_price: {{ plan.price }}
        });
    }
    
    // üìä –¢—Ä–µ–∫–∏–Ω–≥ –∫–ª–∏–∫–∞ –Ω–∞ PayPal
    document.getElementById('paymentForm').addEventListener('submit', function() {
        if (typeof BPPAnalytics !== 'undefined') {
            BPPAnalytics.trackPaymentInitiated('{{ plan.name }}', {{ plan.price }});
        }
    });
});
</script>
{% endblock %}