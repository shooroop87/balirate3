{% extends "account/onboarding/base_onboarding.html" %}
{% load static i18n %}

{% block title %}{% trans "Rezept einreichen" %}{% endblock %}

{% block onboarding_content %}
<div class="onboarding-header">
    <div class="icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="12" y1="18" x2="12" y2="12"/>
            <line x1="9" y1="15" x2="15" y2="15"/>
        </svg>
    </div>
    <h1>{% trans "So funktioniert's" %}</h1>
    <p>{% trans "In 3 einfachen Schritten zu Ihrem pers√∂nlichen Blister" %}</p>
</div>

<!-- Anleitung -->
<div class="instructions">
    <div class="instruction-step">
        <div class="instruction-number">1</div>
        <div class="instruction-content">
            <h3>{% trans "Rezept vom Arzt" %}</h3>
            <p>{% trans "Sie erhalten Ihr Rezept als E-Rezept (QR-Code) oder Papierrezept von Ihrem Arzt." %}</p>
        </div>
    </div>
    
    <div class="instruction-step">
        <div class="instruction-number">2</div>
        <div class="instruction-content">
            <h3>{% trans "Apotheke w√§hlen ODER per Post" %}</h3>
            <div class="instruction-options">
                <div class="option">
                    <span class="option-badge digital">{% trans "Digital" %}</span>
                    <p>{% trans "QR-Code in der App (z.B. Gesund.de) scannen und BlisterPerPost als" %} <strong>Kranich-Apotheke Darmstadt</strong> {% trans "w√§hlen." %}</p>
                </div>
                <div class="option">
                    <span class="option-badge post">{% trans "Per Post" %}</span>
                    <p>{% trans "Anmeldeformular und Freiumschlag zusammen mit dem Rezept an uns senden." %}</p>
                    <div class="download-links">
                        <a href="#" class="download-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            {% trans "Anmeldeformular (PDF)" %}
                        </a>
                        <a href="#" class="download-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            {% trans "Freiumschlag (PDF)" %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="instruction-step">
        <div class="instruction-number">3</div>
        <div class="instruction-content">
            <h3>{% trans "Lieferung alle 7, 14 oder 28 Tage" %}</h3>
            <p>{% trans "Wir pr√ºfen, verblistern und liefern Ihre pers√∂nliche Blisterkarte regelm√§√üig per DHL." %}</p>
            <div class="highlight-box">
                <span class="highlight-icon">üéÅ</span>
                <span>{% trans "Die erste Box ist gratis!" %}</span>
            </div>
        </div>
    </div>
</div>

<div class="divider">
    <span>{% trans "Dokumente hochladen" %}</span>
</div>

<!-- Upload Form -->
<form method="post" enctype="multipart/form-data" class="upload-form">
    {% csrf_token %}
    
    <div class="upload-area" id="uploadArea">
        <input type="file" name="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
        <input type="hidden" name="document_type" value="prescription">
        
        <div class="upload-content" id="uploadContent">
            <div class="upload-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#336AEA" stroke-width="1.5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
            </div>
            <h4>{% trans "Rezept oder Dokument hochladen" %}</h4>
            <p>{% trans "Klicken oder Datei hierher ziehen" %}</p>
            <span class="upload-hint">PDF, JPG, PNG (max. 10MB)</span>
        </div>
        
        <div class="file-selected" id="fileSelected" style="display:none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <polyline points="9 15 12 18 15 15"/>
            </svg>
            <span class="filename" id="fileName"></span>
            <button type="button" class="remove-file" onclick="removeFile()">‚úï</button>
        </div>
    </div>
    
    <div class="upload-actions">
        <button type="submit" class="btn-upload" id="uploadBtn" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            {% trans "Hochladen" %}
        </button>
    </div>
</form>

<!-- Uploaded Documents -->
{% if documents %}
<div class="uploaded-documents">
    <h4>{% trans "Hochgeladene Dokumente" %}</h4>
    <div class="documents-list">
        {% for doc in documents %}
        <div class="document-item">
            <div class="doc-icon {% if doc.status == 'approved' %}approved{% elif doc.status == 'rejected' %}rejected{% endif %}">
                {% if doc.status == 'approved' %}‚úì{% elif doc.status == 'rejected' %}‚úï{% else %}üìÑ{% endif %}
            </div>
            <div class="doc-info">
                <span class="doc-name">{{ doc.original_filename|truncatechars:30 }}</span>
                <span class="doc-type">{{ doc.get_document_type_display }}</span>
            </div>
            <span class="doc-status {{ doc.status }}">{{ doc.get_status_display }}</span>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Navigation -->
<form method="post" style="margin-top:30px;">
    {% csrf_token %}
    <div class="onboarding-actions">
        <a href="{% url 'onboarding_profile' %}" class="btn-onboarding secondary">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            {% trans "Zur√ºck" %}
        </a>
        <button type="submit" name="next_step" class="btn-onboarding primary" {% if not has_prescription %}disabled title="{% trans 'Bitte laden Sie mindestens ein Rezept hoch' %}"{% endif %}>
            {% trans "Weiter" %}
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
        </button>
    </div>
</form>
{% endblock %}

{% block onboarding_css %}
<style>
.instructions { margin-bottom: 40px; }
.instruction-step { display: flex; gap: 20px; margin-bottom: 25px; padding: 20px; background: #f8fafc; border-radius: 16px; transition: all 0.3s; }
.instruction-step:hover { background: #f1f5f9; }
.instruction-number { width: 40px; height: 40px; background: linear-gradient(135deg, #336AEA, #10B981); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; flex-shrink: 0; }
.instruction-content h3 { font-size: 16px; margin: 0 0 8px; color: #1e293b; }
.instruction-content p { font-size: 14px; color: #64748b; margin: 0; }
.instruction-options { margin-top: 15px; display: flex; flex-direction: column; gap: 12px; }
.option { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; }
.option-badge { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; }
.option-badge.digital { background: #dbeafe; color: #1d4ed8; }
.option-badge.post { background: #fef3c7; color: #b45309; }
.option p { font-size: 13px; margin: 0; }
.download-links { display: flex; gap: 15px; margin-top: 12px; flex-wrap: wrap; }
.download-link { display: inline-flex; align-items: center; gap: 6px; color: #336AEA; font-size: 13px; font-weight: 500; text-decoration: none; }
.download-link:hover { text-decoration: underline; }
.highlight-box { display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 10px 18px; border-radius: 10px; margin-top: 12px; font-weight: 600; font-size: 14px; color: #92400e; }
.divider { display: flex; align-items: center; margin: 35px 0 25px; color: #64748b; font-size: 14px; font-weight: 600; }
.divider::before, .divider::after { content: ""; flex: 1; height: 2px; background: #e2e8f0; }
.divider span { padding: 0 20px; }
.upload-area { border: 2px dashed #cbd5e1; border-radius: 16px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; background: #fafbfc; }
.upload-area:hover, .upload-area.dragover { border-color: #336AEA; background: rgba(51, 106, 234, 0.05); }
.upload-content h4 { margin: 15px 0 5px; font-size: 16px; }
.upload-content p { color: #64748b; margin: 0 0 5px; font-size: 14px; }
.upload-hint { font-size: 12px; color: #94a3b8; }
.file-selected { display: flex; align-items: center; justify-content: center; gap: 12px; }
.file-selected .filename { font-weight: 500; color: #10B981; }
.remove-file { background: #fee2e2; border: none; color: #dc2626; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 12px; }
.upload-actions { margin-top: 15px; text-align: center; }
.btn-upload { display: inline-flex; align-items: center; gap: 8px; padding: 12px 25px; background: #10B981; color: #fff; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
.btn-upload:disabled { background: #cbd5e1; cursor: not-allowed; }
.btn-upload:not(:disabled):hover { background: #059669; }
.uploaded-documents { margin-top: 30px; }
.uploaded-documents h4 { font-size: 14px; color: #64748b; margin-bottom: 15px; }
.documents-list { display: flex; flex-direction: column; gap: 10px; }
.document-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; background: #f8fafc; border-radius: 10px; }
.doc-icon { width: 36px; height: 36px; background: #e2e8f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
.doc-icon.approved { background: #d1fae5; }
.doc-icon.rejected { background: #fee2e2; }
.doc-info { flex: 1; display: flex; flex-direction: column; }
.doc-name { font-size: 14px; font-weight: 500; }
.doc-type { font-size: 12px; color: #64748b; }
.doc-status { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
.doc-status.pending { background: #fef3c7; color: #b45309; }
.doc-status.approved { background: #d1fae5; color: #065f46; }
.doc-status.rejected { background: #fee2e2; color: #991b1b; }
</style>
{% endblock %}

{% block onboarding_js %}
<script>
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const uploadContent = document.getElementById('uploadContent');
const fileSelected = document.getElementById('fileSelected');
const fileName = document.getElementById('fileName');
const uploadBtn = document.getElementById('uploadBtn');

uploadArea.addEventListener('click', () => fileInput.click());
uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); if (e.dataTransfer.files.length) { fileInput.files = e.dataTransfer.files; showFile(e.dataTransfer.files[0]); } });
fileInput.addEventListener('change', () => { if (fileInput.files.length) { showFile(fileInput.files[0]); } });

function showFile(file) { uploadContent.style.display = 'none'; fileSelected.style.display = 'flex'; fileName.textContent = file.name; uploadBtn.disabled = false; }
function removeFile() { fileInput.value = ''; uploadContent.style.display = 'block'; fileSelected.style.display = 'none'; uploadBtn.disabled = true; }
</script>
{% endblock %}
{% block analytics_events %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof BPPAnalytics !== 'undefined') {
        BPPAnalytics.trackOnboardingDocuments();
    }
    
    var fileInput = document.getElementById('fileInput');
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0 && typeof BPPAnalytics !== 'undefined') {
                BPPAnalytics.trackDocumentUpload('prescription');
            }
        });
    }
});
</script>
{% endblock %}